---
- name: Build Nginx
  hosts: arm-build
  remote_user: pi
  tasks:
    - name: Ensure docker
      become: yes
      become_method: sudo
      command: docker version
    - name: Copy src
      ansible.builtin.git:
        repo: https://github.com/blong14/scrutiny.git
        dest: /home/pi/scrutiny
        single_branch: yes
        version: main
    - name: Build scrutiny nginx
      become: yes
      become_method: sudo
      command: "docker build -t blong14/nginx:arm-latest -f scrutiny/docker/nginx/Dockerfile scrutiny"
    - name: Push image
      become: yes
      become_method: sudo
      command: "docker push blong14/nginx:arm-latest"
- name: Deploy scrutiny-nginx
  hosts: amd-build
  remote_user: pi
  tasks:
    - name: Ensure Helm
      become: yes
      become_method: sudo
      command: helm version
    - name: Copy src
      ansible.builtin.git:
        repo: https://github.com/blong14/scrutiny.git
        dest: /home/pi/scrutiny
        single_branch: yes
        version: main
    - name: Install scrutiny-nginx
      become: yes
      become_method: sudo
      command: |
        helm upgrade -i scrutiny-nginx scrutiny/charts/nginx \
        --kubeconfig /home/blong14/Developer/compute-cluster/build/etc/rancher/k3s/k3s.yaml \
        --set image.tag=arm-latest
