---
- name: Build Scrutiny
  hosts: arm-build
  remote_user: pi
  tasks:
    - name: Ensure docker
      become: yes
      become_method: sudo
      command: docker version
    - name: Copy src
      ansible.builtin.git:
        repo: https://github.com/blong14/scrutiny.git
        dest: /home/pi/scrutiny
        single_branch: yes
        version: main
      register: clone_status
    - name: Build and Push scrutiny
      become: yes
      become_method: sudo
      ansible.builtin.docker_image:
        build:
          dockerfile: docker/Dockerfile
          path: scrutiny
        name: blong14/scrutiny
        push: true
        source: build
        tag: "{{ item }}"
        force_tag: yes
        force_source: yes
      when: clone_status.changed
      with_items:
        - arm-{{ clone_status.after }}
        - arm-latest