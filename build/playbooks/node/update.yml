---
- name: Update Cluster ARM Based Nodes
  hosts: rasppi
  serial: 1
  tasks:
    - name: Setting node
      shell: echo "{{ inventory_hostname }}" | cut -d "." -f 1
      register: current_worker
    - name: Drain node
      become: yes
      become_method: sudo
      command: kubectl drain {{ current_worker.stdout_lines[0] }} --delete-emptydir-data --ignore-daemonsets
      delegate_facts: True
      delegate_to: "{{ item }}"
      loop: "{{ groups['controller'] }}"
    - name: Update all installed packages
      apt:
        name: '*'
        state: latest
        update_cache: yes
        only_upgrade: yes
      register: apt_update_status
    - name: Remove packages not needed anymore
      apt:
        autoremove: yes
    - name: Clean images
      become: yes
      become_method: sudo
      command: "docker system prune -f"
    - name: Reboot when packages were updated
      reboot:
        post_reboot_delay: 60
      when: apt_update_status.changed
    - name: Uncordon node
      become: yes
      become_method: sudo
      command: kubectl uncordon {{ current_worker.stdout_lines[0] }}
      delegate_facts: True
      delegate_to: "{{ item }}"
      loop: "{{ groups['controller'] }}"
